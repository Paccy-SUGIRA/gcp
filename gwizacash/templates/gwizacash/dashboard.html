{% extends 'gwizacash/base.html' %}

{% load static %}
{% load humanize %}

{% block title %}Dashboard | GwizaCash{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    {% if messages %}
        <div class="row">
            <div class="col-12">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <!-- Overdue Loans Alert - ADD THIS NEW SECTION -->
    {% if overdue_loans %}
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-danger alert-dismissible fade show">
                <h5><i class="bi bi-exclamation-triangle"></i> Urgent: Overdue Loans</h5>
                <p class="mb-2">You have {{ overdue_loans|length }} overdue loan(s) with total penalties of {{ loan_penalties|floatformat:0|intcomma }} RWF.</p>
                <a href="{% url 'gwizacash:my_loans' %}" class="btn btn-danger btn-sm">View & Pay Now</a>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- User Information Card -->
    <div class="row mb-4">
        <div class="col-xl-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Welcome, {{ request.user.get_full_name|default:request.user.username }}</h4>
                    <span class="badge bg-light text-dark">{{ user_type }}</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3"> <!-- CHANGED: col-md-4 to col-md-3 -->
                            <div class="card h-100 border-primary">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Total Savings</h5>
                                    <h3 class="text-primary">{{ total_savings|floatformat:0|intcomma }} RWF</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3"> <!-- CHANGED: col-md-4 to col-md-3 -->
                            <div class="card h-100 border-success">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Shares</h5>
                                    <h3 class="text-success">{{ paid_shares }} / {{ committed_shares }}</h3>
                                    <div class="progress mt-2">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ share_percentage }}%;"
                                              aria-valuenow="{{ share_percentage }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ share_percentage }}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3"> <!-- CHANGED: col-md-4 to col-md-3 -->
                            <div class="card h-100 border-warning"> <!-- CHANGED: border-danger to border-warning -->
                                <div class="card-body text-center">
                                    <h5 class="card-title">Active Loans</h5> <!-- CHANGED: Total Loan Balance to Active Loans -->
                                    <h3 class="text-warning">{{ user_active_loans.count }}</h3> <!-- CHANGED: Show count instead of balance -->
                                    <small class="text-muted">Balance: {{ total_loan_balance|floatformat:0|intcomma }} RWF</small> <!-- ADDED: Show balance as subtitle -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card h-100 border-danger">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Total Penalties</h5>
                                    <h3 class="text-danger">{{ total_penalties|floatformat:0|intcomma }} RWF</h3>
                                    <small class="text-muted">
                                        {% if overdue_loans %}
                                            {{ overdue_loans|length }} overdue loan(s)
                                        {% else %}
                                            All payments current
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

  <!-- Most Urgent Payment Information -->
    <div class="row mb-4">
        <div class="col-xl-12">
            <div class="card shadow">
                <div class="p-3 mb-2 bg-dark text-white">
                    <h4 class="mb-0">Payment Status</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 {% if urgent_type == 'PENALTY' %}border-danger{% elif urgent_type == 'OVERDUE_LOAN' %}border-warning{% elif urgent_type == 'MONTHLY_DEPOSIT' %}border-info{% elif urgent_type == 'NEXT_PAYMENT' %}border-success{% else %}border-secondary{% endif %}">
                                <div class="card-body text-center">
                                    <h5 class="card-title">{% if urgent_type == 'NEXT_PAYMENT' %}Next Payment{% else %}Most Urgent{% endif %}</h5>
                                    {% if urgent_payment %}
                                        <h3 class="{% if urgent_type == 'PENALTY' %}text-danger{% elif urgent_type == 'OVERDUE_LOAN' %}text-warning{% elif urgent_type == 'MONTHLY_DEPOSIT' %}text-info{% elif urgent_type == 'NEXT_PAYMENT' %}text-success{% endif %}">
                                            {{ urgent_payment }}
                                        </h3>
                                        <p><strong>{{ urgent_amount|floatformat:0 }} RWF</strong></p>
                                        {% if urgent_date %}
                                            <p class="text-muted">{% if urgent_type == 'NEXT_PAYMENT' %}Due:{% else %}Due:{% endif %} {{ urgent_date|date:"d M Y" }}</p>
                                        {% endif %}
                                    {% else %}
                                        <h3 class="text-success"><i class="fas fa-check-circle"></i></h3>
                                        <p>All payments current</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>                        
                        
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 border-primary">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Current Month</h5>
                                    <h3>{{ current_month_paid }} / 1</h3>
                                    <p>{% if has_monthly_payment %}Paid{% else %}Not Paid{% endif %}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 {% if total_penalties > 0 %}border-danger{% else %}border-success{% endif %}">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Penalties</h5>
                                    
                                    {% if total_penalties > 0 %}
                                        <h3 class="text-danger">{{ total_penalties|floatformat:0 }} RWF</h3>
                                        <p class="text-muted">
                                            {% if user_penalties %}{{ user_penalties.count }} deposit{% endif %}
                                            {% if user_penalties and overdue_loans %} + {% endif %}
                                            {% if overdue_loans %}{{ overdue_loans|length }} loan{% endif %}
                                        </p>
                        
                                        {# Pay the first unpaid penalty #}
                                        {% if user_penalties %}
                                            <a href="{% url 'gwizacash:pay_penalty' user_penalties.first.id %}" class="btn btn-danger btn-sm">
                                                Pay Penalty
                                            </a>
                                        {% endif %}
                                        
                                    {% else %}
                                        <h3 class="text-success"><i class="fas fa-check-circle"></i></h3>
                                        <p>No penalties</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Group Financials (Visible to All Users) -->


    <div class="row mb-4">
        <div class="col-xl-12">
            <div class="card shadow">
                <div class="p-3 mb-2 bg-dark text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Group Financials</h4>
                    <a href="{% url 'gwizacash:group_financials' %}" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-graph-up"></i> View Details
                    </a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Total Group Wealth</h5>
                                    <h3>{{ collective_fund.total_amount|floatformat:0|intcomma }} RWF</h3>
                                    <small>All deposits + profits</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Available Cash</h5>
                                    <h3>{{ collective_fund.available_amount|floatformat:0|intcomma }} RWF</h3>
                                    <small>Ready for loans</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Outstanding Loans</h5>
                                    <h3>{{ collective_fund.total_loans_outstanding|floatformat:0|intcomma }} RWF</h3>
                                    <small>Money loaned out</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Available Profit</h5>
                                    <h3>{{ collective_fund.available_profit|floatformat:0|intcomma }} RWF</h3>
                                    <small>Ready for distribution</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Profit Summary Row -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-success">Total Profit Earned</h6>
                                    <h4 class="text-success">{{ collective_fund.total_profit_earned|floatformat:0|intcomma }} RWF</h4>
                                    <small class="text-muted">Interest + Penalties</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-primary">Total Distributed</h6>
                                    <h4 class="text-primary">{{ collective_fund.total_profit_distributed|floatformat:0|intcomma }} RWF</h4>
                                    <small class="text-muted">Given to members</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    {% if request.user.userprofile.user_type == 'COORDINATOR' %}
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card bg-secondary text-dark shadow">
            <div class="card-body text-center">
                <h5 class="card-title">Total Members</h5>
                <h3>{{ total_members }}</h3>
                <small>
                    Members: {{ members_only }} |
                    Coordinators: {{ coordinators }}
                </small>
            </div>
            <div class="card-footer d-grid">
                <a href="{% url 'gwizacash:manage_members' %}" class="btn btn-light btn-sm">Manage Members</a>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card bg-secondary text-dark shadow">
            <div class="card-body text-center">
                <h5 class="card-title">Loans Overview</h5>
                <div class="d-flex justify-content-around">
                    <div>
                        <div class="fw-bold">{{ pending_loan_requests }}</div>
                        <small>Pending</small>
                    </div>
                    <div>
                        <div class="fw-bold">{{ approved_loans_count }}</div>
                        <small>Approved</small>
                    </div>
                    <div>
                        <div class="fw-bold">{{ active_loans_count }}</div>
                        <small>Active</small>
                    </div>
                </div>
            </div>
            <div class="card-footer d-flex justify-content-around">
                <a href="{% url 'gwizacash:loan_management' %}?status=REQUESTED" class="btn btn-outline-light btn-sm">Pending</a>
                <a href="{% url 'gwizacash:loan_management' %}?status=APPROVED" class="btn btn-outline-light btn-sm">Approved</a>
                <a href="{% url 'gwizacash:loan_management' %}?status=ACTIVE" class="btn btn-outline-light btn-sm">Active</a>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card bg-secondary text-dark shadow">
            <div class="card-body text-center">
                <h5 class="card-title">Pending Deposits</h5>
                <h3>{{ pending_deposits_count }}</h3>
            </div>
            <div class="card-footer d-grid">
                <a href="{% url 'gwizacash:pending_deposits' %}" class="btn btn-dark btn-sm">Review Deposits</a>
            </div>
        </div>
    </div>
</div>
{% endif %}



<!-- Recent Activity Dashboard -->
<div class="container-fluid py-4">

    {% if messages %}
      <div class="mb-3">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  
    <div class="row">
        <!-- Recent Deposits -->
        <div class="col-xl-4 mb-4">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">Recent Deposits</h4>
                </div>
                <div class="card-body">
                    {% if recent_deposits %}
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for deposit in recent_deposits %}
                                    <tr>
                                        <td>{{ deposit.date|date:"d M Y" }}</td>
                                        <td>{{ deposit.amount|floatformat:0|intcomma }} RWF</td>
                                        <td>
                                            {% if deposit.status == 'PENDING' %}
                                                <span class="badge bg-warning">Pending</span>
                                            {% elif deposit.status == 'APPROVED' %}
                                                <span class="badge bg-success">Approved</span>
                                            {% elif deposit.status == 'REJECTED' %}
                                                <span class="badge bg-danger">Rejected</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-piggy-bank fa-2x text-muted mb-2"></i>
                            <p class="text-muted">No recent deposits found.</p>
                        </div>
                    {% endif %}
                    <div class="d-grid">
                        <a href="{% url 'gwizacash:create_deposit' %}" class="btn btn-success">
                            <i class="fas fa-plus-circle me-1"></i> Make a Deposit
                        </a>
                    </div>
                </div>
            </div>
        </div>
  
       <!-- Active Loans -->
        <!-- Active Loans -->
        <div class="col-xl-4 mb-4">
            <div class="card shadow">
                <div class="card-header bg-warning text-white">
                    <h4 class="mb-0">My Active Loans</h4>
                </div>
                <div class="card-body">
                    {% if user_active_loans %}
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Loan #</th>
                                        <th>Remaining</th>
                                        <th>Due Date</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for loan in user_active_loans %}
                                    <tr {% if loan.is_overdue %}class="table-danger"{% endif %}>
                                        <td>
                                            #{{ loan.id }}
                                            {% if loan.is_overdue %}
                                                <span class="badge bg-danger badge-sm">Overdue</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ loan.remaining_balance|floatformat:0|intcomma }} RWF</td>
                                        <td>{{ loan.due_date|date:"d M Y" }}</td>
                                        <td>
                                            {% if loan.status == 'DISBURSED' or loan.status == 'ACTIVE' %}
                                                <a href="{% url 'gwizacash:pay_loan' loan.id %}" 
                                                class="btn btn-primary btn-sm" 
                                                data-bs-toggle="tooltip" 
                                                data-bs-placement="top" 
                                                title="Make a payment for Loan #{{ loan.id }}"
                                                aria-label="Pay Loan #{{ loan.id }}">
                                                    <i class="fas fa-credit-card me-1"></i> Pay
                                                </a>
                                            {% elif loan.status == 'APPROVED' %}
                                                <span class="text-muted">Awaiting disbursement</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex gap-2 mb-2">
                            <a href="{% url 'gwizacash:my_loans' %}" class="btn btn-info btn-sm flex-fill">
                                <i class="fas fa-list me-1"></i> View All
                            </a>
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-hand-holding-usd fa-2x text-muted mb-2"></i>
                            <p class="text-muted">No active loans found.</p>
                        </div>
                    {% endif %}
                    <div class="d-grid">
                        {% if not user_active_loans %}
                            <a href="{% url 'gwizacash:request_loan' %}" class="btn btn-warning">
                                <i class="fas fa-hand-holding-usd me-1"></i> Request a Loan
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Activity/Transactions -->
        <div class="col-xl-4 mb-4">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">Recent Activity</h4>
                </div>
                <div class="card-body">
                    {% if recent_transactions %}
                        <div class="activity-feed" style="max-height: 300px; overflow-y: auto;">
                            {% for transaction in recent_transactions|slice:":3" %}
                            <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                                <div class="flex-shrink-0">
                                    {% if transaction.transaction_type == 'DEPOSIT' %}
                                        <i class="fas fa-arrow-up text-success"></i>
                                    {% elif transaction.transaction_type == 'LOAN_DISBURSEMENT' %}
                                        <i class="fas fa-hand-holding-usd text-warning"></i>
                                    {% elif transaction.transaction_type == 'LOAN_PAYMENT' %}
                                        <i class="fas fa-arrow-down text-primary"></i>
                                    {% elif transaction.transaction_type == 'PENALTY' %}
                                        <i class="fas fa-exclamation-triangle text-danger"></i>
                                    {% else %}
                                        <i class="fas fa-exchange-alt text-info"></i>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1 ms-2">
                                    <div class="fw-bold">{{ transaction.get_transaction_type_display }}</div>
                                    <small class="text-muted">{{ transaction.created_at|date:"d M Y" }}</small>
                                </div>
                                <div class="flex-shrink-0">
                                    <span class="badge bg-secondary">{{ transaction.amount|floatformat:0|intcomma }} RWF</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-history fa-2x text-muted mb-2"></i>
                            <p class="text-muted">No recent activity found.</p>
                        </div>
                    {% endif %}
                    <div class="d-grid">
                        <a href="{% url 'gwizacash:transaction_history' %}" class="btn btn-info">
                            <i class="fas fa-history me-1"></i> View All Activity
                        </a>
                    </div>
                </div>
            </div>
        </div>

        
    </div>
  </div>
  

</div>
{% endblock %}
