{% extends 'gwizacash/base.html' %}
{% load humanize %}

{% block title %}Loan Management - GwizaCash{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col-md-8">
            <h2>Loan Management</h2>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h6>Collective Fund Status</h6>
                    <p class="mb-1">Total: <strong>{{ collective_fund.total_amount|floatformat:0|intcomma }} RWF</strong></p>
                    <p class="mb-0">Available: <strong>{{ collective_fund.available_amount|floatformat:0|intcomma }} RWF</strong></p>
                </div>
            </div>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="loanTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button">
                Pending Requests <span class="badge bg-warning ms-1">{{ pending_loans.count }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved" type="button">
                Ready to Disburse <span class="badge bg-info ms-1">{{ approved_loans.count }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button">
                Active Loans <span class="badge bg-success ms-1">{{ active_loans.count }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button">
                Pending Payments <span class="badge bg-primary ms-1">{{ pending_payments.count }}</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="loanTabsContent">
        <!-- Pending Loan Requests -->
        <div class="tab-pane fade show active" id="pending" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Member</th>
                                    <th>Amount</th>
                                    <th>Interest</th>
                                    <th>Total</th>
                                    <th>Duration</th>
                                    <th>Request Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for loan in pending_loans %}
                                <tr>
                                    <td>{{ loan.user.get_full_name|default:loan.user.username }}</td>
                                    <td>{{ loan.amount|floatformat:0|intcomma }} RWF</td>
                                    <td>{{ loan.interest_amount|floatformat:0|intcomma }} RWF</td>
                                    <td>{{ loan.total_amount|floatformat:0|intcomma }} RWF</td>
                                    <td>{{ loan.duration }} months</td>
                                    <td>{{ loan.request_date|date:"M d, Y" }}</td>
                                    <td>
                                        <form method="post" action="{% url 'gwizacash:approve_loan' loan.id %}" class="d-inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="approve">
                                            <button type="submit" class="btn btn-sm btn-success me-1">Approve</button>
                                        </form>
                                        <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#rejectLoanModal{{ loan.id }}">
                                            Reject
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center">No pending loan requests</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Approved Loans (Ready to Disburse) -->
        <div class="tab-pane fade" id="approved" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Member</th>
                                    <th>Amount</th>
                                    <th>Total Amount</th>
                                    <th>Duration</th>
                                    <th>Approved Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for loan in approved_loans %}
                                <tr>
                                    <td>{{ loan.user.get_full_name|default:loan.user.username }}</td>
                                    <td>{{ loan.amount|floatformat:0|intcomma }} RWF</td>
                                    <td>{{ loan.total_amount|floatformat:0|intcomma }} RWF</td>
                                    <td>{{ loan.duration }} months</td>
                                    <td>{{ loan.approval_date|date:"M d, Y" }}</td>
                                    <td>
                                        <form method="post" action="{% url 'gwizacash:disburse_loan' loan.id %}" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-primary" 
                                                    {% if loan.amount > collective_fund.available_amount %}disabled title="Insufficient funds"{% endif %}>
                                                Disburse
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center">No approved loans pending disbursement</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Loans -->
        <div class="tab-pane fade" id="active" role="tabpanel">
            <div class="mt-3">
                <!-- Overdue Loans -->
                {% if overdue_loans %}
                <div class="card mb-3 border-danger">
                    <div class="card-header bg-danger text-white">
                        <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Overdue Loans ({{ overdue_loans|length }})</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Member</th>
                                        <th>Remaining</th>
                                        <th>Due Date</th>
                                        <th>Days Overdue</th>
                                        <th>Penalty</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for loan in overdue_loans %}
                                    <tr>
                                        <td>{{ loan.user.get_full_name|default:loan.user.username }}</td>
                                        <td>{{ loan.remaining_balance|floatformat:0|intcomma }} RWF</td>
                                        <td>{{ loan.due_date|date:"M d, Y" }}</td>
                                        <td><span class="badge bg-danger">{{ loan.days_overdue }} days</span></td>
                                        <td>{{ loan.calculate_penalty|floatformat:0|intcomma }} RWF</td>
                                        <td><span class="badge bg-warning">{{ loan.status }}</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Current Active Loans -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Current Active Loans</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Member</th>
                                        <th>Total Amount</th>
                                        <th>Remaining</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for loan in current_loans %}
                                    <tr>
                                        <td>{{ loan.user.get_full_name|default:loan.user.username }}</td>
                                        <td>{{ loan.total_amount|floatformat:0|intcomma }} RWF</td>
                                        <td>{{ loan.remaining_balance|floatformat:0|intcomma }} RWF</td>
                                        <td>{{ loan.due_date|date:"M d, Y" }}</td>
                                        <td><span class="badge bg-success">{{ loan.status }}</span></td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center">No current active loans</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Payments -->
        <div class="tab-pane fade" id="payments" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Member</th>
                                    <th>Loan Amount</th>
                                    <th>Payment Amount</th>
                                    <th>Remaining After</th>
                                    <th>Payment Date</th>
                                    <th>Bank Slip</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in pending_payments %}
                                <tr>
                                    <td>{{ payment.loan.user.get_full_name|default:payment.loan.user.username }}</td>
                                    <td>{{ payment.loan.total_amount|floatformat:0|intcomma }} RWF</td>
                                    <td>{{ payment.amount|floatformat:0|intcomma }} RWF</td>
                                    <td>
                                        {% with remaining=payment.loan.remaining_balance|add:payment.amount|floatformat:0|intcomma %}
                                            {{ remaining }} RWF
                                        {% endwith %}
                                    </td>
                                    <td>{{ payment.payment_date|date:"M d, Y H:i" }}</td>
                                    <td>
                                        {% if payment.bank_slip %}
                                            <a href="{{ payment.bank_slip.url }}" target="_blank" class="btn btn-sm btn-outline-primary">View Slip</a>
                                        {% else %}
                                            <span class="text-muted">No slip</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <form method="post" action="{% url 'gwizacash:approve_loan_payment' payment.id %}" class="d-inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="approve">
                                            <button type="submit" class="btn btn-sm btn-success me-1">Approve</button>
                                        </form>
                                        <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#rejectPaymentModal{{ payment.id }}">
                                            Reject
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center">No pending loan payments</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reject Loan Modals -->
{% for loan in pending_loans %}
<div class="modal fade" id="rejectLoanModal{{ loan.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject Loan Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'gwizacash:approve_loan' loan.id %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="reject">
                    <p>Are you sure you want to reject this loan request of <strong>{{ loan.amount|floatformat:0|intcomma }} RWF</strong> from <strong>{{ loan.user.get_full_name|default:loan.user.username }}</strong>?</p>
                    <div class="mb-3">
                        <label for="rejection_reason{{ loan.id }}" class="form-label">Rejection Reason:</label>
                        <textarea class="form-control" id="rejection_reason{{ loan.id }}" name="rejection_reason" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Reject Loan</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Reject Payment Modals -->
{% for payment in pending_payments %}
<div class="modal fade" id="rejectPaymentModal{{ payment.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'gwizacash:approve_loan_payment' payment.id %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="reject">
                    <p>Are you sure you want to reject this payment of <strong>{{ payment.amount|floatformat:0|intcomma }} RWF</strong> from <strong>{{ payment.loan.user.get_full_name|default:payment.loan.user.username }}</strong>?</p>
                    <div class="mb-3">
                        <label for="rejection_reason{{ payment.id }}" class="form-label">Rejection Reason:</label>
                        <textarea class="form-control" id="rejection_reason{{ payment.id }}" name="rejection_reason" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Reject Payment</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}
